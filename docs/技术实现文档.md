# PinMuxLab 技术实现文档

## 1. 项目概述
PinMuxLab 是一个基于 Web 的 MCU 引脚配置工具（Pin Muxing Tool），旨在帮助嵌入式开发人员可视化地配置芯片引脚功能，并实时解决引脚冲突问题。项目采用数据驱动的架构，支持通过 JSON 文件灵活定义不同型号的芯片。

## 2. 技术栈
- **核心框架**: Vue 3 (Composition API) + TypeScript
- **构建工具**: Vite
- **状态管理**: Pinia
- **样式方案**: CSS Variables (原生支持深色模式切换)
- **可视化**: 原生 SVG (无第三方图形库依赖，轻量级)
- **图标库**: 自定义 SVG 组件

## 3. 核心运行原理

### 3.1 数据驱动架构 (Data-Driven Architecture)
项目的核心在于将芯片定义与业务逻辑分离。每个芯片由一个独立的 JSON 文件描述，位于 `src/assets/chips` 目录下。
数据结构主要包含三个部分：
1.  **Meta**: 芯片基本信息（厂商、系列、内核、存储容量、Datasheet链接等）。
2.  **Package**: 物理封装信息（引脚布局坐标、尺寸、形状）。
3.  **Peripherals**: 外设定义及其引脚映射关系。

### 3.2 动态推理机制 (Inference Engine)
为了降低 JSON 数据的维护成本，项目实现了 `chipInferencer.ts` 推理引擎。
- **输入**: JSON 中仅包含“物理引脚列表”和“外设-引脚映射表”。
- **输出**: 运行时自动反向生成“引脚-功能列表”（即每个引脚能做什么）。
- **智能命名**: 自动处理多映射方案（Pin Remap/Alternate Functions），为冲突的功能名添加后缀（如 `CAN_TX_1`, `CAN_TX_2`）。
- **类型识别**: 结合 `src/config/pinConfig.ts` 中的正则规则，自动识别 Power, Ground, Reset, Boot, NC 等特殊引脚。

## 4. 关键模块实现流程

### 4.1 状态管理 (`chipStore.ts`)
Pinia Store 是应用的数据中枢，维护以下核心状态：
- **`currentChip`**: 当前加载的完整芯片对象（经过推理增强后的数据）。
- **`pinConfigurations`**: 一个简单的 Key-Value 映射对象 (`{ "PA9": "USART1_TX" }`)，记录当前所有已配置的引脚。这是“单一数据源”，UI 的所有状态（如引脚颜色、外设勾选状态）都由此衍生。
- **`selectedPinName`**: 当前用户点击选中的引脚，用于驱动左侧边栏详情显示。
- **`hoveredPinName`**: 鼠标悬停的引脚，用于实现“外设列表”与“芯片视图”的高亮联动。

### 4.2 芯片可视化渲染 (`ChipPackage.vue`)
芯片视图完全通过 SVG 动态生成，不依赖 Canvas 库，便于交互和样式控制。
- **自动布局 (`packageLayout.ts`)**: 解析 JSON 中的引脚坐标，计算 SVG 的 `viewBox` 和引脚的几何属性。
- **交互层**:
    - **缩放/平移**: 监听 `wheel` 和 `mousemove` 事件，通过 CSS `transform` 实现平滑缩放。
    - **点击事件**: 实现了 `pin-click` (选中引脚) 和 `canvas-click` (取消选中) 逻辑。
- **样式系统**: 利用 CSS 变量 (`src/styles/chip-theme.css`) 定义引脚颜色。组件根据引脚的 `type` (power, gnd, nc, gpio) 动态添加 CSS 类名，实现差异化渲染。

### 4.3 外设配置与冲突检测 (`PeripheralCard.vue`)
这是右侧边栏的核心组件，负责展示单个外设的配置界面。
- **逻辑流程**:
    1.  **加载**: 读取 Store 中的外设定义。
    2.  **分组**: 将信号（如 TX, RX）及其所有可用引脚选项（PA9, PB6...）进行分组。
    3.  **状态计算**:
        - `isPinOccupied`: 检查某个候选项引脚是否已被其他功能占用。
        - `isSignalFullyOccupied`: 如果某信号的所有候选引脚都被占用，标记为冲突（红色）。
    4.  **交互**: 用户勾选功能时，调用 `chipStore.setPinFunction` 更新全局配置。

### 4.4 引脚分类配置 (`pinConfig.ts`)
为了灵活处理不同芯片的特殊引脚，项目提取了配置文件：
- 定义了 `PIN_CATEGORIES` (power, gnd, clock, reset, boot, nc)。
- 使用正则表达式 (`GPIO_REGEX`) 区分普通 I/O 和特殊功能引脚。
- 这种设计允许在不修改核心代码的情况下，通过调整配置适配不同厂商的命名规范。

## 5. 用户交互流程 (User Flow)

1.  **芯片选择**:
    - 启动时，`PinMuxEditor.vue` 通过 `import.meta.glob` 扫描所有 JSON 文件。
    - 解析 Meta 信息构建 "Vendor -> Family -> Chip" 级联菜单。
    - 用户选择后，加载 JSON 并执行推理逻辑。

2.  **功能配置 (两种方式)**:
    - **方式 A (外设优先)**: 在右侧列表勾选 "USART1 TX"，系统自动选择默认引脚（如 PA9）。如果 PA9 被占用，用户需手动在下拉框切换到 PB6。
    - **方式 B (引脚优先)**: 在中间视图点击 PA9，左侧边栏显示 PA9 支持的所有功能，用户直接选择 "USART1_TX"。

3.  **视觉反馈**:
    - **已配置引脚**: 变为绿色 (Green)，显示功能名称。
    - **特殊引脚**: 显示特定颜色（黄色系/电源色），不可点击配置。
    - **冲突/不可用**: 在下拉列表中置灰或标记为冲突。
    - **联动高亮**: 鼠标悬停在右侧外设项时，中间视图对应的物理引脚同步高亮。

4.  **数据导出**:
    - 提供 CSV 导出功能，遍历 `pinConfigurations` 生成引脚配置表，便于导入 EDA 工具或生成代码。

## 6. 目录结构说明

```
src/
├── assets/chips/       # 芯片数据源 (JSON)
├── components/         # Vue 组件
│   ├── ChipPackage.vue # 核心 SVG 芯片视图
│   ├── PeripheralCard.vue # 外设配置卡片
│   └── ...
├── config/
│   └── pinConfig.ts    # 引脚分类配置
├── stores/
│   └── chipStore.ts    # Pinia 状态管理
├── utils/
│   ├── chipInferencer.ts # 数据推理引擎
│   └── packageLayout.ts  # SVG 布局计算
├── views/              # 页面级组件
└── styles/             # 全局样式与主题
```
